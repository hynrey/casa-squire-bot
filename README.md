# Casa Squire Bot

Телеграм-бот, который по команде владельца планирует выключение Windows-компьютера. В ответ на `/shutdown` бот показывает кнопки: выключить сразу, через 1–4 часа или отменить уже запланированное выключение.

## Требования
- Windows 10/11 или WSL с доступом к `cmd.exe` и команде `shutdown`.
- Python 3.11+ в `PATH`.
- Токен бота от BotFather и Telegram ID владельца (переменные `BOT_TOKEN`, `OWNER_IDS` в `.env`).

## Файлы
- `install_windows.bat` — создаёт venv, ставит зависимости, спрашивает токен/ID, пишет `.env`, настраивает задачу автозапуска в Планировщике задач (имя `CasaSquireBot`, запускает `run.bat`). Если файл переименовали, поправьте путь в скрипте.
- `run_windows.bat` — активирует venv и запускает `python bot.py`.
- `bot.py` — входная точка бота (Aiogram 3).
- `pyproject.toml` / `poetry.lock` — список зависимостей (экспортируйте `requirements.txt`, если его нет: `poetry export -f requirements.txt -o requirements.txt`).

## Установка на Windows
1) Убедитесь, что установлен Python 3.11+ и доступен в `PATH`.  
2) Запустите `install_windows.bat` (при проблемах с задачей автозапуска — «Запуск от имени администратора»).  
   - Скрипт создаст `venv`, обновит `pip`, установит зависимости из `requirements.txt`, откроет BotFather и `@userinfobot`, запросит `BOT_TOKEN` и `OWNER_ID`, запишет `.env`.  
   - Настроит автозапуск через Планировщик задач: при входе в систему будет выполняться `run.bat`, который активирует venv и стартует бота.

## Запуск вручную
- Из корня проекта: `run_windows.bat`  
  или вручную:  
  ```bash
  .\\venv\\Scripts\\activate
  python bot.py
  ```

## Запуск под WSL
- Скрипты `.bat` можно вызвать через `cmd.exe /C`, но Планировщик задач из WSL не настроится автоматически.  
- Убедитесь, что `cmd.exe` доступен (обычно `/mnt/c/Windows/System32/cmd.exe`) и текущий пользователь Windows имеет права выполнять `shutdown`.  
- Создайте `.env` вручную (`BOT_TOKEN`, `OWNER_IDS=123456789`), соберите зависимости командой `pip install -r requirements.txt` (или `pip install aiogram pydantic pydantic-settings` при отсутствии файла), затем запустите `python bot.py` из активированного venv.

## Ограничения и особенности
- Бот работает только в приватных чатах и только для `OWNER_IDS`. Остальные пользователи его не увидят (middleware отбрасывает события).  
- Выключение/отмена выполняются через `cmd.exe /c shutdown`, поэтому бот не пригоден для чистого Linux/Mac.  
- Для автозапуска нужна задача Планировщика; если она не создалась, удалите/создайте её вручную с запуском `run_windows.bat` из корня проекта.  
- Команда отмены доступна только пока таймер выключения активен; после завершения ожидания отменить нельзя.
